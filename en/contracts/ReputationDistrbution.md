# Reputation Distribution

`NOTICE`: текущая группа контрактов, именуемая нами как MultiSig, в данном документе называется Arbitration. Здесь это необходимо для различия групп контрактов, использующих мультисиги и конкретных контрактов мультисигов. В дальнейшем, необходимо придумать более подходящее название для этой группы контрактов. Аналогично изменено название MultiSigRegistry => ArbitrationRegistry.

### Контракты

* `SpaceLocker` - контракт блокировки Space токена. Дает возможность заблокировать только один Space токен. Создается только с помощью фабрики. Единственный возможный владелец - тот адрес, который запросил фабрику создать контракт (возможность передачи контракта отсутствует).
* `SRA` - `SpaceReputationAccounting` - контракты учета и распределения репутации за Space токены делегатам. Контракты SRA предоставляются как 3-ими сторонами так и GaltCore командой.
* `ASRA` - `Arbitration SRA` - контракт учета репутации, реализованный командой GaltSpace для учета и распределения репутации по группам контрактов Arbitration.
* `RSRA` - `Reference SRA` - контракт, разработанный GaltSpace и являющийся полнофункциональным и рабочим примером реализации SRA для нужд частного фонда
* `3SRA` - `3rd party SRA` - контакты учета репутации, которые разработала какая-либо 3-я сторона.

### Терминология

* `TRMC` - `Total Reputation Minted Counter` - счетчик кол-ва адресов, на которые заминчена репутация с данного SpaceLocker
* `Arbitration` - (сейчас MultiSig) группа контрактов ArbitratorsMultiSig + ArbitratorVoting + OracleStakesAccounting
* `Fund` - референсная группа контрактов, использующих репутацию Space токенов и разработанная для использования группами местного самоуправления


## SpaceLocker

![alt text](https://docs.google.com/drawings/d/e/2PACX-1vTLbXG1TU-JbJrPeBOJoElf-cd-RDeJbSeiVmyPdJ_H1zJYp4r8FnKZbhGKxEOr7Tl0EjIYgAztrhDy/pub?w=1610&h=1458)

* Для минта репутации в SRA владелец SpaceLocker выполняет следующие действия:
    * Вызывает метод #mint(sraAddress) в контракте SpaceLocker - аналог approve erc20.
        * TRMC инкрементируется при каждом минте в новый уникальный SRA
    * Вызывает метод #sync(lockerAddress) в контракте SRA - аналог transferFrom erc20. (разработчик реализует это действие на свое усмотрение).
        * Если для текущего адреса есть заминченная репутация по указанному адресу - происходит ее синхронизация с текущим контрактом
* Для сжигания репутации, пользователь должен:
    * Вызывает метод #burn(lockerAddress) в контракте SRA (разработчик реализует это действие на свое усмотрение).
        * Контракт SRA на запрос balanceOf(lockerAddress) должен отдавать 0
    * Вызывает метод #sync(sraAddress) в контракте SpaceLocker
        * Если контракт SRA на запрос balanceOf(lockerAddress) вернет 0, репутация, TRMC декрементируется на 1.
* Прочие особенности учета репутаций на SpaceLocker
    * Mint/Burn возможен только для полного веса токена. Возможность частичного mint/burn не предусматривается, т.к. не имеет смысла - раздробить заминченную репутацию можно по какой угодно логике в контракте SRA.
    * Владелец SpaceLocker может вывести токен на свой адрес только в случае, если счетчик заминченных репутаций равен 0.

## ASRA(Arbitration SpaceReputationAccounting) и контракты Arbiration

![alt text](https://docs.google.com/drawings/d/e/2PACX-1vQtja1-NTq5jgExmi3uo_la_5W6W1bNq4WAmOxX7KVtn1OVMUCP4CCsWCNz-lF56l3FJRMkKhjtLyLf/pub?w=1325&h=513)

* Контракт учитывает и перераспределяет репутацию между владельцем и делегатами
* Контракт позволяет переносить репутацию делегатов в контракты голосований, которые в свою очередь входят в группу контрактов Arbitration. Перевод репутации разрешен только в те контракты голосований, мультисиги которых зарегистрированы в ArbitrationRegistry .
* При переводе N репутации в конкретный мультисиг:
    * В реестре делегированных балансов баланс делегата уменьшается на N
    * В реестре блокировок баланс делегата увеличивается на N
    * Контракт голосования, указанный в вызове метода перевода репутации, уведомляется о новом балансе залоченной репутации с помощью коллбека.
        * При положительном изменении, репутация засчитывается на баланс делегата. После этого он может распределить ее между кандидатами по своему усмотрению. Присутствует ограничение максимального кол-ва делегатов, сейчас это 5.
        * При негативном изменении баланса делегата в контракте голосования, в рамках той же транзакции что и коллбеке, происходит он-чейн проход по списку кандидатов, которым были распределены голоса делегата, и списания с них этих голосов (в произвольном порядке). Ввиду того, что у нас есть ограничение (до 5 кандидатов), данная операция вполне помещается в блок.
* При отзыве репутации из Arbitration самим делегатом:
    * В реестре блокировок баланс делегата уменьшается на N
    * В реестре делегированных балансов баланс делегата увеличивается на N
    * Контракт голосования, указанный в вызове метода перевода репутации, уведомляется о новом балансе залоченной репутации с помощью коллбека.
* При отзыве репутации из Arbitration владельцем репутации, он должен указать конкретный адрес голосования, за которым заблокирована репутация:
    * В реестре блокировок баланс делегата уменьшается на N
    * В реестре делегированных балансов баланс владельца репутации увеличивается на N
    * Контракт голосования, указанный в вызове метода перевода репутации, уведомляется о новом балансе залоченной репутации с помощью коллбека.

## RSRA(Reference SpaceReputationAccounting) и контракты уровня Fund

![alt text](https://docs.google.com/drawings/d/e/2PACX-1vSxFUa8lXEZq3qVc5QZkvnK7wwphf_COWPN1C0nuKFf_VtxXFRWfq32g5qwPEizqvgw9aLRpMCwPXir/pub?w=1325&h=513)

* Контракт входит в группу контрактов Fund и разворачивается вместе с остальными контрактами.
* Контракт учитывает и перераспределяет репутацию между владельцем и делегатами.
* Контракт позволяет синхронизировать текущее значение баланса делегата с контрактами, его использующими. В отличии от имплементации ASRA, в RSRA репутация не перетекает из SRA контракта в другой контракт. Вместо этого, контракт RSRA информирует другой контракт о текущем заблокированном значении заблокированной для использования репутации делегата. Такой коллбек - единственный способ информировать другие контракты об изменении баланса.
* Владелец репутации должен иметь возможность отозвать репутации делегата за одно действие. Поэтому мы вынуждены одной транзакцией проходить по всем зарегистрированным контрактам, в которые послано уведомление о балансе делегата и уведомлять их об отзыве репутации. Поэтому, в таких контрактах мы не будем держать сложной логики распределения репутации (без множественного распределения и дальнейших коллбеков).
* Информирование о текущем значении репутации возможно 3 мя способами. Во всех этих трех случаях вызываются коллбеки всех контрактов фонда, которые пользуются этими значениями :
    * Блокировка своей репутации делегатом на контракте RSRA #lock(owner, amount)
    * Разблокировка своей репутации делегатом на контракте RSRA #unlock(owner, amount)
    * Принудительная разблокировка репутации делегата ее владельцем #revokeLocked(delegate, amount)
* Ручное уведомление конкретного контракта фонда об изменениях заблокированного баланса не предусмотрено, т.к. выполняется через коллбеки.
* Контракт может быть создан через фабрику любым владельцем 721 токена SPACE. При создани  контракта создатель указывает ряд параметров: тип контракта (открытый - любой владелец 721 может создать репутацию , закрытый - создать репутацию можно только после одобрения N участников с репутацией в контракте ), количество подписей, необходимых для утверждения нового члена сообщества, процент голосов от общей репутации, необходимый для утверждения контракта в белом листе контрактов принятия решений, процент голосов от общей репутации, необходимый для изменения параметров контракта учета репутации.
* Вместе с контрактом учета репутации создается 2 связанных базовых конракта принятия решений: белый лист контрактов принятия решений, контракт изменения параметров контракта учета репутации.
* Контракт белого листа контрактов принятия решений представляет собой контракт аналогичный контракту выбора Арбитров. Вместо адресов арбитров контракт содержит адреса контрактов принятия решений. Любой адрес, имеющий репутацию в контракте учета репутации может добавить адрес контракта. Контракт считается допустимым, если количество голосов за контракт, превышает учтановленный минимальный порог.
* Контракт изменения параметров контракта учета репутации. Контракт для изменения установленных при создании параметров. Каждый имеющий репутацию может создать предложение на изменение параметра. Контракт аналогичен контракту белого листа и содержит вместо адресов - список предложений на изменение конкретного параметра контракта учёта Репутации. Если предложение набирает количество голосов, большее, чем необходимо для принятия решения, то любой может вызвать метод и изменить параметр контракта. Если предложение принято и параметр изменён, то предложение меняет статус на «принято» и исключается из голосования.
* Если контракт учёта Репутации является закрытым, то для создания Репутации в контракте нужно подтверждение N адресов, которые уже имеют репутацию в контракте. Если количество адресов в контракте меньше N, то нужно подтверждение всех адресов. После подтверждения N адресов происходит mint Репутации.
* Контракт наложения штрафа на участника сообщества. Аналогичен контракту изменения параметров контракта Репутации. Предложение содержит адрес, размер штрафа, валюту, адрес мультисига для оплаты, причину предложения. Предложение может подать любой член сообщества с репутацией.
При принятии решения - фиксируется размер штрафа на участника сообщества в Eth или любых ERC 20 в контракте учёта Репутации. Предложение исключается из голосования изменением статуса. Без погашения штрафа невозможно сжечь репутацию и соответственно разлочить 721 токен.
* Контракт исключения члена из сообщества - аналогичен контракту наложения штрафа. При наборе предложения порога по количеству голосов - любой может вызвать метод и сжечь репутацию. Вне зависимости от наличия штрафов Репутация сжигается, адрес исключается из контракта учёта Репутации.


## Внутренняя логика контрактов уровня Fund - TBD

## Предложения

Предложение по облегчению вывода токенов с локера в случае если контракт публично признан мошенническим или бажным.
* Кто то курирует реестр таких контрактов
* Если адрес SRA находится в таком списке
    * У пользователя есть предупреждение, но не запрещение при минте в такой SRA
    * Пользователь может сжечь репутацию в таком SRA с помощью отдельного метода (выполнится запрос к реестру). Это явно покажет, что SRA и все действия/голосования в этом фонде не основываются на реальной репутации
    * Владелец фонда может исправить контракт и развернуть новую версию.
