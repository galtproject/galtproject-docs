# Контракт PlotEscorow

## Описание проблемы
После регистрации земельного участка Пользователь должен иметь возможность получить и принять предложение о его купле - продаже до регистрации Кастодиана, до есть до передачи прав собственности на участок Кастодиану.

## Особенности
Контракт использует функциональность PlotCustodianManager.

## Аналоги
https://opensea.io/ - наиболее подходящий аналог.

https://rarebits.io

https://www.emoon.io

## Роли заявки
Роли валидаторов, используемые в заявках, жестко прописаны в контракте PlotEscrow. Список ролей в контракте Validators, который задается вручную, должен четко ему соответствовать

* `PE_AUDITOR` - Аудитор

## Содержание заявки на продажу

* ID токена упаковки
* Адрес кастодиана
* Цена
* Валюта - ERC20 или ETH (Валюта комиссии и валюта заявки являются могут различаться)
* Адрес токена для ERC20
* Дата создания
* Список хешей прилагаемых документов из IPFS. Задается только один раз и не может быть модифицирован.
*  Предложения
    * Адрес покупателя
    * Первая сделанная ставка
    * Последняя сделанная ставка
    * Дата первой ставки
    * Дата последней ставки

## Статусы заявок на продажу

* OPEN - Продажа открыта для создания новых офферов и изменения текущих
* LOCKED - Заблокирована выбранным продавцом оффером, подача новых офферов и изменение текущих заблокирована
* CLOSED - Продажа закрыта (как успешно так и нет). Дальнейшая работа с офферами невозможна.

## Статусы офферов
* OPEN - оффер открыт
* MATCH - продавец выбрал этот оффер для дальнейшей работы с ним
* ESCROW - токены поступили, ожидается подтверждение сделки продавцом и покупателем
* AUDIT_REQUIRED - кто то из участников сделки запросил аудит ее отмену
* AUDIT - аудит сделки
* RESOLVED - сделка подтверждена, ожидается вывод токенов
* CLOSED - продажа закрыта успешно
* CANCELLED - продажа отменена покупателем либо аудитором

## Интерфейс для продавца

#### #openSale()
Продавец выставляет токен на продажу
* Статус заявки устанавливается в OPEN
* Создать заявку может только владелец Space токена
* Назначается единственная роль валидатора - `PE_AUDITOR`
* Оплачивается комиссия в ETH или GALT

#### #changeOfferAsk()
Продавец пересматривает свое пожелание только для конкретного оффера
* Разрешен только для заявок в статусе OPEN
* Разрешен только для офферов в статусе OPEN
* Предложение продавца не может быть меньше оффера покупателя

#### #selectOffer()
Продавец выбирает оффер, с которым он будет работать
* Разрешен только для заявок в статусе OPEN
* Разрешен только для офферов в статусе OPEN
* Разрешен только, если оценки и покупателя и продавца равны
* Статус заявки устанавливается в LOCKED
* Статус оффера устанавливается в MATCH

#### #attachSpaceToken()
Продавец прикрепляет свой токен к паре заявка/предложение
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для офферов в статусе MATCH
* Может быть прикреплен токен, id которого изначально указано в заявке

#### #withdrawSpaceToken()
Продавец отзывает свой Space токен с контракта
* Разрешен только для заявок в статусе CLOSED
* Разрешен только для предложений в статусах CANCELLED
* Статус заявки и статусы оффера не меняются

#### #claimPayment()
Продавец выводит вознаграждение за SpaceToken
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для офферов в статусе RESOLVED
* Если покупатель уже вывел Space токен - статус заявки и оффера меняются на CLOSED

#### #cancelSaleOrder()
Продавец закрывает продажу токена
* Разрешен только для заявок в статусе OPEN
* Статус заявки устанавливается в CANCELLED
* Статусы офферов не меняются

#### #reopenSaleOrder()
Продавец переоткрывает продажу токена
* Разрешен только для заявок в статусе CANCELLED
* Статус заявки устанавливается в OPEN
* Оплата должна быть выведенеа с активного оффера
* Статусы офферов не меняются

## Интерфейс для покупателя

#### #createOffer()
Покупатель делает оффер по покупке участка
* Разрешен только для заявок в статусе OPEN
* Покупатель указывает свой оффер в валюте заявки
* Создается запись оффера привязанного к указанному предложению
* Один адрес может сделать только одно предложение к конкретному офферу

#### #changeOfferBid()
Покупатель изменяет свой оффер по покупке участка
* Разрешен только для заявок в статусе OPEN
* Разрешен только для предложений в статусе OPEN

#### #attachPayment()
Покупатель прикрепляет платеж за покупку токена
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для предложений в статусе MATCH
* Токен валюты и сумма должны быть равными токену и сумме, указанными в заявке

#### #withdrawPayment()
Покупатель отзывает свой платеж с контракта
* Разрешен только для заявок в статусе CLOSED
* Разрешен только для предложений в статусе CANCELLED
* Статус заявки и статусы оффера не меняются

#### #claimSpaceToken()
Покупатель забирает купленный SpaceToken с контракта

* Разрешен только для заявок в статусе LOCKED
* Разрешен только для офферов в статусе RESOLVED
* Если продавец уже вывел платеж - статус заявки и оффера меняются на CLOSED

## Общий интерфейс для продавца и покупателя

#### #cancelOffer()
Продавец или покупатель отказывается работать с оффером
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для офферов в статусе MATCH
* Не имеет значения, переведены какие-либо токены на контракт или нет
* Статус заявки устанавливается в CLOSED
* Статус оффера устанавливается в CANCELLED

#### #requestCancellationAudit()
Покупатель или продавец могут запросить аудитора остановить текущий оффер и вернуть обратно токены
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для предложений в статусе ESCROW
* Статус оффера меняется на AUDIT_REQUIRED

#### #resolve()
Продавец или покупатель соглашаются на обмен токенами
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для офферов в статусе ESCROW
* Разрешен только в случае, если участок находится на контракте и для него назначен кастодиан
* Статус оффера устанавливается в RESOLVED

## Интерфейс для аудитора

#### #lockForAudit()
Аудитор блокирует за собой оффер
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для предложений в статусе AUDIT_REQUIRED
* Статус оффера меняется на AUDIT

#### #cancellationAuditReject()
Аудитор отказывает в обратном выводе токенов с контракта
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для офферов в статусе AUDIT
* Статус оффера меняется на ESCROW

#### #cancellationAuditApprove()
Аудитор одобряет закрытие оффера без обмена токенами
* Разрешен только для заявок в статусе LOCKED
* Разрешен только для предложений в статусе AUDIT
* Продавец может забрать Space токен обратно
* Покупатель может забрать токены, в которых была произведена оплата, с контракта
* Заявка переходит в статус CLOSED
* Оффер переходит в статус CANCELLED
* Заявка не может продолжать работать с другими офферами, требуется создание новой заявки

## Пользовательские сценарии

### Сценарий №1: Создание предложения о продаже участка.

1. Пользователь в приложении в разделе Мои участки для участка может нажать кнопку "Выставить на продажу".
2. В новом всплывающем окне он указывает: Эфиры или Контракат ERC 20 токенов в которых будет осуществлена сделка, сумма продажи, IPFS хеши фотографий и документов. Так же пользователь указывает комисси в GALT (по аналогии с другими заявками).
3. Пользователь нажимает кнопку "Подать заявку", создается транзакция с методом Создать заявку.
4. Теперь заявка видна в разделе "Маркетплейс". 

### Сценарий №2: Создание предложения о покупке Участка
1. Любой пользователь может зайти в раздел Маркетплейс и увидеть все участки, которые выставлены на текущий момент. Информация: ID, кастодиан, если есть, цена, символ токена, контракт токена (если есть), IPFS хеш. Если есть предложения, то предложения. 
2. Пользователь нажимает кнопку "Сделать предложение". Появляется поле для ввода суммы в токенах заявки.
3. Пользователь вводит суммы и нажимат "Подтвердить". Создается и отправляется транзакция.
4. Здесь к заявке на продажу создается структура данных - OFFER, которая имеет уникальный ID, ссылку на заявку, Покупателя, Цену предложения покупателя, Цену предложения Продавца.

### Сценарий №3: Принятие предложения о покупке участка.

1. Продавец рядом с каждым предложением может нажать кнопку "Ответить". Появляется окно, где он может указать свое предложение в токенах заявки. Продавец ставит свою цену для сделанного предложения. Цена заявки не коректируется. Например, Продавец, поставил начальную цену 10 000, Покупатель поставил 9000, Продавец может откорректировать цену на 9400. Здесь устанавливается цена Продавца для конкретного OFFER ID.
2. Если Сумма по предложению продавца и покупателя совпадают, то статус заявки меняется на "Готова к Escrow".
3. Продавец может нажать кнопку "Согласиться", тогда будет передена цена из предложения.
4. Продавец может передать токен Space на контракт. Для этого он нажимает передать на контракт. Как только токен передан на контракт статус заявки меняется на SPACE получен(ил выставляется флаг).
5. Здесь везде фигурирует отдельная структура данных - OFFER, которая имеет поле Цена покупателя и Цена продавца, которые могут меняться пока не станут равны. Когда они станут равны - меняется статус заявки.

### Сценарий №4: Отправка токенов для покупки участка на контракт

1. Продавец, если заявка имеет статус Готова к Escrow, может нажать кнопку перевести токены на контракт. Создаются транзакции на перевод Эфиров или ERC20 токенов для покупки.
2. После того, как токен участка и токены для покупки были переведены, то токены могут быть возвращены сторонам только Валидатором с ролью Аудитор.
3. Если токен SPACE и оплата получены контрактом, то статус - ESCROW.

### Сценарий №5: Проведение сделки
1. Сделка может быть осуществлена, если у участка назначен кастодиан.
2. Если кастодиан не назначен, то Владелец может отсюда создать заявку и назначить Кастодиана (аналогично PLotCustodianManager).
3. Если Кастодиан назначен, то Сделка осуществляется автоматически. Покупатель получает токен Участка, Продавец -  Эфиры или ERC20.
4. Стаус заявки - CLOSED.

### Сценарий №6: Возвращение токена SPACE
1. Продавец может вернуть токен SPACE до получения Контрактом токенов покупателя.
2. Для этого он нажимает кнопку "Вернуть Участок".

### Сценарий №7: Возвращение токенов Покупателю
1. Поккупатель может вернуть токены или Эфиры до получения Контрактом токена SPACE.
2. Для этого он нажимает кнопку "Вернуть оплату".

### Сценарий №8: Возвращение токенов Покупателю и Продавцу
1. Каждый участник сделки может нажать "Запросить отмену сделки".
2. Аудитор может назначить себе такую заявку.
3. После того, как она назначена он может нажать "Отменить сделку". В таком случае статус заявки меняется, токены возвращаются, комиссия не возвращается.
4. Аудитор может получить 50% от оплаченной комиссии, остальное получает GALT SPACE.

### Сценарий №9: Одобрение сделки Кастодианом
1. Если на момент подачи Завки кастодиан не был назначен, то требуется его подпись.
2. В меню он должен Нажать кнопку "Подтвердить сделку". Создается транзакция и выставляется флаг в контракте.
3. Если Кастодиан назначен, то флаг выставляется при создании заявки автоматически.
